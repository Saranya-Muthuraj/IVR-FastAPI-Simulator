# IVR Simulator - Defect Tracker

This file logs all known bugs and issues for the IVR project and related components.

| ID  | Priority | Status | Category | Title                                          | Description                                                                                                                              | Solution                                                                                                                     |
| --- | -------- | ------ | -------- | ---------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| 001 | **High** | **FIXED** | Backend  | "Call not found" error on Render (Multi-Worker) | The app used `active_calls = {}` (in-memory). This fails when a new request goes to a different Gunicorn worker that doesn't have the call data. | Replaced `active_calls` dictionary with database-backed state using the `CallHistory` table for all read/write operations. |
| 002 | **High** | **FIXED** | Testing  | `(sqlite3.OperationalError) no such table` in `pytest` | The in-memory test database was being destroyed between tests, so tables didn't exist when the tests ran. | Modified `test_ivr_simulator.py` to use a `StaticPool` for the in-memory engine, ensuring a single, persistent connection. |
| 003 | **Medium** | **FIXED** | Database | `database.py` JSON field default bug          | `CallHistory` model used `default=[]` for JSON fields, which shares the *same list object* across all new rows, causing data corruption. | Changed defaults to `default=list` and `default=lambda: ["main"]` to create a new, unique list for each new row. |
| 004 | **Low** | **FIXED** | Backend  | `DeprecationWarning` for `@app.on_event`       | The `@app.on_event("startup")` decorator is outdated and was causing warnings during testing and deployment. | Replaced the decorator with the modern `lifespan` context manager in `ivr_simulator_backend.py`. |
| 005 | **High** | **FIXED** | NLU/Logic | DTMF input buffer not clearing on menu change    | If a user typed `123` in the PNR menu, then pressed `*` to go back, the `123` was still in the buffer when they entered a new menu. | Added logic in `handle_dtmf` to check if `action == "goto_menu"` and clear `call.input_buffer` before changing the menu. |
| 006 | **Medium** | **FIXED** | NLU/Logic | Voice NLU mapping "two" to "to" or "four" to "for" | NLU was getting confused by common homophones (words that sound the same), causing it to fail number entry. | Added a "filler word" list (like 'to', 'for', 'a') and stripped them from the voice input *before* mapping numbers. |
| 007 | **Medium** | **FIXED** | Logic    | Race Condition: Booking last seat              | If two users tried to book the last seat at the exact same time, both could succeed, resulting in a negative seat count (`-1`). | Implemented a database lock (or re-fetched seat count) inside the `confirm_booking` function just before the final `db.commit()`. |
| 008 | **Medium** | **FIXED** | Frontend | "Start Call" button not re-enabled on API error | If the `/ivr/start` API call failed (e.g., server was down), the green "Start Call" button stayed disabled, forcing a page refresh. | Added a `catch (error)` block in the `startCall()` JavaScript function to re-enable the button if the `fetch` call fails. |
| 009 | **Low** | **FIXED** | Frontend | Call timer doesn't stop on hangup           | User hangs up, but the `00:01`, `00:02`... timer on the screen continues to run until the call fully ends from the server side. | Ensured `clearInterval(durationInterval)` was called immediately in the `endCall()` JavaScript function, not just in `processBackendResponse`. |
| 010 | **Medium** | **FIXED** | NLU/Logic | Booking wizard state not clearing on cancel | User starts booking (enters name, age), then presses `*` to go to the main menu. When they start a *new* booking, the old name and age are still there. | Added logic to the "go to main menu" action to set all `call.booking_...` fields in the database back to `None`. |
| 011 | **Medium** | **FIXED** | Django   | Static files (CSS/JS) not loading in production | `manage.py runserver` worked, but on deployment (Gunicorn), all styles were missing. `DEBUG=False` was set. | Installed `whitenoise` and configured it in `settings.py` and `wsgi.py` to allow Django to serve its own static files. |
| 012 | **Low** | **FIXED** | NLU/Logic | Spoken PNR with letters fails                | NLU could only understand "two four one two three four" but not "Alpha India one two three four" (for AI1234). | The `map_spoken_pnr` function was expanded to include a dictionary for letters to numbers (e.g., 'a', 'b', 'c' -> '2'). |
| 013 | **Low** | **FIXED** | Frontend | TTS speech starts before voices are loaded   | On some browsers (like Chrome), the first "Welcome" message would fail to play because the TTS engine wasn't ready. | Added a `voiceLoadGuard()` function that waits for the `window.speechSynthesis.onvoiceschanged` event before allowing the first call. |
| 014 | **Medium** | **FIXED** | Django   | Error on glossary page with special characters | A Django glossary app would crash if a user searched for a term with a query parameter like `?q=%`. | Used `urllib.parse.unquote` in the Django view to properly decode the URL query before using it in a database lookup. |
| 015 | **High** | **FIXED** | Logic    | `cancel_flight` does not increment seat count | When a user cancelled a flight, the `status` was set to "Cancelled," but the `seats_available` count was not increased, losing the seat. | Updated the `cancel_flight` logic to find all other bookings for that same flight and increment their `seats_available` count by 1. |
| 016 | **Medium** | Open   | NLU/Logic | NLU fails on hyphenated names (e.g., "Al-Jaber") | The `booking_ask_name` logic strips special characters, turning "F. Al-Jaber" into "F Aljaber". | (Plan: Update NLU regex to allow hyphens and periods in names). |
| 017 | **Low** | Open   | Frontend | Chat bubbles overflow container screen      | A very long IVR prompt (like the main menu) breaks the UI layout on smaller mobile screens. | (Plan: Add `word-wrap: break-word;` and `max-width: 100%;` to the `.ivr-message` CSS class). |
| 018 | **Low** | **FIXED** | Database | `postgres://` vs `postgresql://` Render error | The `DATABASE_URL` from Render starts with `postgres://`, but SQLAlchemy requires `postgresql://`, causing a connection error. | Added a check in `database.py` to automatically replace the prefix if it is found, making the app compatible with Render. |
| 019 | **Medium** | Open   | NLU/Logic | Call does not timeout on user silence     | If a user connects but says nothing and presses no buttons, the call stays active forever, using server resources. | (Plan: Implement a timeout function that triggers an "Are you still there?" prompt and then hangs up). |
| 020 | **Medium** | **FIXED** | App Inventor | Google Apps Script returns HTML, not JSON | MIT App Inventor `Web` component was getting a full HTML error page instead of a JSON error message from Google Apps Script. | In the Apps Script `doGet/doPost` function, wrapped all returns in `ContentService.createTextOutput(JSON.stringify(response)).setMimeType(ContentService.MimeType.JSON);`. |
| 021 | **Low** | **FIXED** | Frontend | `NaN:NaN` shown for call duration            | If a user hangs up immediately after starting a call (within 1 second), the `endCall()` function calculates a `NaN` duration, logging "Ended (NaN:NaN mins)". | Added a check in `endCall()` to default the duration to 0 if `callStartTime` is null or the calculation results in `NaN`. |
| 022 | **Medium** | **FIXED** | Backend  | NLU confuses "zero" with "oh"                | User trying to enter "AI 101" (one-zero-one) would be interpreted as "one-oh-one". `map_spoken_flight_number` failed. | Added `"oh": "0"` to the `num_word_map` dictionary in all NLU helper functions. |
| 023 | **High** | **FIXED** | Database | `psycopg2-binary` missing from `requirements.txt` | The app worked locally with `sqlite:///` but crashed on Render because the PostgreSQL driver was not installed. | Added `psycopg2-binary` to the `requirements.txt` file so the Render deployment installs it. |
| 024 | **Medium** | **FIXED** | Frontend | User can "spam" DTMF keys while IVR is speaking | The keypad was not disabled while the Text-to-Speech (TTS) was active. Users could press 5 keys, and the backend would receive all 5 at once. | In JavaScript, set `keypad.disabled = true` at the start of the `speakText()` function and set it back to `false` in the `utterance.onend` event. |
| 025 | **Medium** | Open   | Backend  | Invalid PNR format `12345` crashes `/dtmf`     | If a user enters a 5-digit PNR and presses `#`, the backend check `len(call.input_buffer) != 6` catches it, but the NLU doesn't. | The `map_spoken_pnr` function should also check the *length* of the found digits and return `None` if it's not exactly 6. |
| 026 | **Low** | **FIXED** | Frontend | Backend API URL is hardcoded                 | The `API_BASE_URL` in `ivr_simulator.html` was set to `http://localhost:8000`. This failed when the HTML was opened from a different PC. | Changed the `API_BASE_URL` to the public Render URL (`https://...onrender.com`) so the frontend can be run from anywhere. |
| 027 | **Medium** | **FIXED** | Django   | Admin login fails on deployed server         | The Django admin panel worked locally but gave a 500 error on Render/Gunicorn. `ALLOWED_HOSTS` was set correctly. | The `CSRF_TRUSTED_ORIGINS` setting in `settings.py` was missing the `https://...onrender.com` URL. Added it. |
| 028 | **High** | Open   | Security | User can check status of *any* PNR           | The system only asks for a 6-digit PNR. A person could guess PNRs and get passenger names and flight details. | (Plan: Add a second verification step, like "Please say the first 3 letters of the passenger's last name"). |
| 029 | **Low** | **FIXED** | Frontend | Voice "Listening" icon (`ðŸ”´`) stays on     | If the user clicked the mic button but said nothing, the `onend` event fired, but the `isListening` state was not reset, so the red dot stayed on. | Ensured `stopListening()` function was called in *all* `recognition.onerror` and `recognition.onend` events. |
| 030 | **Medium** | **FIXED** | Logic    | Booking `6E204` fails                      | User tries to book flight `6E204`. The NLU finds it, but the `lookup_flight_for_booking` logic only checks for an `AI` prefix. | The `lookup_flight_for_booking` function was modified to *not* add the "AI" prefix if the input already contains letters. |
| 031 | **Medium** | Open   | Logic    | Frequent Flyer PIN check is case-sensitive | A user's PIN `1234` is stored as a string. If the NLU accidentally interprets it as `" 1234 "` (with a space), the check `ff_info.pin == pin_entered` fails. | Used `pin_entered.strip()` in `verify_ff_pin` to remove any leading/trailing whitespace before checking the PIN. |
| 032 | **Low** | **FIXED** | Django   | Secret key visible in `settings.py` on GitHub | The `SECRET_KEY` was typed directly into `settings.py`, which is a security risk. | Moved the `SECRET_KEY` to an environment variable and loaded it in `settings.py` using `os.environ.get('SECRET_KEY')`. |
| 033 | **Medium** | **FIXED** | App Inventor | App crashes when Google Script request fails | If the Google Apps Script had an error, it returned an HTML error page. MIT App Inventor tried to parse this HTML as JSON and crashed. | Implemented `try...catch` blocks in the Google Apps Script `doGet/doPost` to always return a valid JSON response, e.g., `{ "status": "error", "message": e.message }`. |
| 034 | **High** | Open   | Security | No rate limiting on `/ivr/start`               | A malicious user could run a script to call `/ivr/start` 10,000 times a second, filling the database and crashing the server. | (Plan: Implement `fastapi-limiter` to limit new calls to 10 per minute from a single IP address). |
| 035 | **Low** | **FIXED** | Frontend | Long PNR status message is not spoken      | The final PNR status message ("Your PNR AI1234... This call will now end.") was very long. On some browsers, the TTS would cut off early. | This was a browser bug. The fix was to split the long message into two separate `speakText()` calls, one after the other. |
| 036 | **Medium** | **FIXED** | Database | Cannot find flight with different case (e.g., `ai101`) | User says "ai one zero one". NLU maps it to `ai101`. The database query `flight == "AI101"` fails because it is case-sensitive. | Changed the database query to be case-insensitive: `filter(Booking.flight.ilike(flight_input))` (using `.ilike()`). |
| 037 | **Medium** | **FIXED** | Logic    | "Back" (`*`) from `manage_booking_options` fails | User enters PNR, gets to "Press 1 to Change, 2 to Cancel". They press `*` to go back, but the app stays on the same menu. | The `*` option in the `manage_booking_options` menu was missing its `action: "goto_menu"` and `target: "main"`. Added it. |
| 038 | **Low** | **FIXED** | Django   | `created_at` field shows wrong time on server | A Django model with `auto_now_add=True` showed the correct time locally, but the wrong time (UTC) on the server. | Set the `TIME_ZONE = 'Asia/Kolkata'` in the Django `settings.py` file. |
| 039 | **High** | **FIXED** | Deployment | CORS Error: Frontend cannot call Render API    | The `ivr_simulator.html` file (on a local PC) was blocked by the browser from calling the `...onrender.com` API due to CORS policy. | Added `CORSMiddleware` to the FastAPI app (`app.add_middleware(...)`) and set `allow_origins=["*"]` to allow all browsers to call the API. |
| 040 | **Medium** | Open   | Logic    | Booking fails if flight has no other bookings | The `confirm_booking` logic gets flight details (route, time) from `all_bookings_for_flight[0]`. If a *new* flight is added with 0 bookings, this line fails. | (Plan: Store flight route/time in a separate `Flights` table, so booking is not dependent on an existing booking). |
| 041 | **Medium** | Open   | Logic    | Booking for age "0" or "120" fails           | The `set_age_and_ask_gender` logic checks for `0 < age < 120`. This incorrectly rejects a 6-month-old infant (age 0) or a 120-year-old. | (Plan: Change the logic to `0 <= age <= 120` to include these edge cases). |
| 042 | **Low** | **FIXED** | Frontend | `ivr-output` chat does not auto-scroll       | When the IVR or user speaks, the new message appears, but the user has to manually scroll down to see it. | In the `addToOutput` and `speakText` JavaScript functions, added the line `outputDiv.scrollTop = outputDiv.scrollHeight;` to force scrolling. |
| 043 | **High** | Open   | Security | User can cancel *another person's* flight    | If a user knows someone else's PNR, they can go to "Manage Booking" and cancel it. There is no second verification (like name or email). | (Plan: Add a step in `lookup_pnr_manage` to ask for the passenger's last name before showing the cancel/change options). |
| 044 | **Medium** | **FIXED** | NLU/Logic | NLU maps "one one one" as "111" not "1 1 1"    | User trying to say PNR `111222` would say "one one one...". The NLU speech recognizer would write it as "111 222". The regex failed. | Modified the NLU regex to accept spaces between digits, e.g., `re.sub(r'[\s.-]+', '', spoken_text)`, to clean all spaces. |
| 045 | **Low** | **FIXED** | Frontend | HTML file uses `http://` for Render API      | The `API_BASE_URL` was `http://...onrender.com`. Browsers gave a "Mixed Content" error because the page was loaded on `https:` but the API was `http:`. | Changed the `API_BASE_URL` in `ivr_simulator.html` to use `https://` to match the secure Render deployment. |
| 046 | **Medium** | Open   | Logic    | User can book a flight that is "Cancelled"   | The `lookup_flight_for_booking` logic only checks `seats_available > 0`. It doesn't check if the flight's `status` is "Cancelled". | (Plan: Add a check in `lookup_flight_for_booking` to ensure `flight_info.status != "Cancelled"` before allowing a booking). |
| 047 | **Low** | **FIXED** | Deployment | `create_db.py` script runs on Render       | The `create_db.py` script was still in the repo. Render's build process tried to run it and failed because it didn't have the DB URL. | The script was unnecessary. Deleted `create_db.py` and moved all setup logic into the `lifespan` function in the main backend file. |
| 048 | **High** | Open   | Database | No index on `call_history.call_id`           | The app is constantly querying `filter(CallHistory.call_id == ...)`. Without an index, this will become very slow as the table grows to millions of calls. | (Plan: Add `index=True` to the `call_id` column in the `CallHistory` model in `database.py` and generate a new migration). |
| 049 | **Low** | **FIXED** | NLU/Logic | NLU "back" command fails in root menu      | If the user says "go back" at the `main` menu, the NLU maps this to `*`. The `main` menu has no `*` option, so it says "Invalid option". | Modified the NLU "back" logic to check `if original_menu != "main": digit_to_press = "*"`. This prevents it from firing at the main menu. |
| 050 | **Medium** | **FIXED** | Database | `FOREIGN KEY` constraint missing             | A user could cancel a PNR in the `bookings` table, but their `call_history` entries would still reference a PNR that no longer exists. | Added a `ForeignKey` relationship between `CallHistory.active_pnr` and `Bookings.pnr_key` to maintain database integrity. |